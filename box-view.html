<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>รายละเอียดกล่อง</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Thai:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    :root {
      --bg: #f3f6fb;
      --card: rgba(255,255,255,0.9);
      --text: #0f172a;
      --muted: #475569;
      --border: #dbe4f0;
      --primary: #2563eb;
      --primary2: #1d4ed8;
      --shadow: 0 18px 46px rgba(15,23,42,0.14);
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "IBM Plex Sans Thai", sans-serif;
      color: var(--text);
      background: radial-gradient(1200px 540px at 8% -14%, rgba(59,130,246,0.22), rgba(59,130,246,0)), var(--bg);
    }

    .shell { max-width: 1100px; margin: 0 auto; padding: 14px; }
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 18px;
      box-shadow: var(--shadow);
      padding: 14px;
      margin-bottom: 12px;
      backdrop-filter: saturate(160%) blur(8px);
    }

    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .title { margin: 0; font-size: 1.1rem; font-weight: 800; }
    .muted { color: var(--muted); }

    .btn {
      border: none;
      border-radius: 999px;
      height: 38px;
      padding: 0 14px;
      color: #fff;
      font: inherit;
      font-weight: 700;
      cursor: pointer;
      background: linear-gradient(180deg, var(--primary), var(--primary2));
    }
    .btn.secondary { background: #334155; }
    .btn.outline {
      background: #fff;
      color: var(--primary2);
      border: 1px solid #93c5fd;
    }

    .actions { display: flex; gap: 8px; flex-wrap: wrap; }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 0.8rem;
      font-weight: 800;
      border: 1px solid var(--border);
      background: #eef4ff;
      color: #334155;
    }

    .chip.warn { border-color: rgba(185,28,28,.45); background: rgba(254,226,226,.8); color: #991b1b; }

    .doc-card {
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 12px;
      margin-bottom: 8px;
      background: #f8fbff;
      cursor: pointer;
      transition: transform .16s ease, box-shadow .2s ease;
    }

    .doc-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 14px 26px rgba(15,23,42,.12);
    }

    .doc-top {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 5px;
    }

    .doc-title { font-size: 0.95rem; font-weight: 800; color: #1d4ed8; }
    .doc-sub { font-size: 0.8rem; color: #64748b; }
    .doc-subject { font-size: 0.9rem; line-height: 1.35; margin-bottom: 6px; }
    .doc-foot {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      font-size: 0.78rem;
      color: #475569;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 0.72rem;
      font-weight: 800;
      border: 1px solid var(--border);
      background: #eef4ff;
      color: #334155;
    }

    .badge.ok { color: #166534; border-color: rgba(22,163,74,.45); background: rgba(22,163,74,.12); }
    .badge.warn { color: #92400e; border-color: rgba(217,119,6,.45); background: rgba(217,119,6,.12); }
    .badge.err { color: #991b1b; border-color: rgba(220,38,38,.45); background: rgba(220,38,38,.12); }
    .badge.info { color: #075985; border-color: rgba(14,165,233,.45); background: rgba(14,165,233,.12); }

    .empty {
      text-align: center;
      color: #64748b;
      font-weight: 600;
      padding: 18px;
    }

    .error {
      border: 1px solid rgba(220,38,38,.35);
      background: rgba(220,38,38,.08);
      color: #991b1b;
      border-radius: 10px;
      padding: 10px;
      font-size: 0.9rem;
    }

    .hidden { display: none !important; }

    @media (max-width: 900px) {
      .doc-top { flex-direction: column; }
      .doc-foot { flex-direction: column; align-items: flex-start; }
    }
  </style>
</head>
<body>
  <div class="shell">
    <div class="card topbar">
      <div>
        <h1 class="title">กล่องเอกสาร</h1>
        <div id="boxHead" class="muted" style="font-size:0.84rem">กำลังโหลด...</div>
      </div>
      <div class="actions">
        <button id="btnBack" class="btn secondary" type="button"><i class="bi bi-arrow-left"></i> กลับ</button>
        <button id="btnReload" class="btn outline" type="button"><i class="bi bi-arrow-clockwise"></i> โหลดใหม่</button>
      </div>
    </div>

    <div id="errBox" class="error hidden"></div>

    <div id="mainWrap" class="hidden">
      <div class="card" style="text-align:center;">
        <div class="muted" style="font-size:0.82rem;">QR กล่อง</div>
        <img id="boxQr" alt="QR" style="width:min(72vw,220px);max-width:220px;aspect-ratio:1/1;border:1px solid var(--border);border-radius:12px;padding:4px;background:#fff;object-fit:contain;">
        <div class="actions" style="justify-content:center;margin-top:8px;">
          <button id="btnPrintQr" class="btn outline" type="button"><i class="bi bi-printer"></i> พิมพ์ QR กล่อง</button>
        </div>
      </div>

      <div class="card">
        <div class="actions" id="summaryChips"></div>
      </div>

      <div class="card">
        <div class="topbar" style="margin-bottom:8px;">
          <div class="title" style="font-size:1rem;">รายการเอกสารในกล่อง</div>
          <div class="actions">
            <button id="btnPrintList" class="btn" type="button"><i class="bi bi-printer-fill"></i> พิมพ์รายการ</button>
          </div>
        </div>
        <div id="docsWrap"></div>
      </div>
    </div>
  </div>

  <script src="./config.js"></script>
  <script src="./api-client.js"></script>
  <script src="./app-common.js"></script>
  <script>
    (function () {
      'use strict';

      var C = window.DocFrontendCommon;
      var query = C.parseQuery();
      var boxName = C.safeTrim(query.box || '');

      var state = {
        api: null,
        settings: null,
        user: null,
        detail: null
      };

      var els = {
        boxHead: document.getElementById('boxHead'),
        btnBack: document.getElementById('btnBack'),
        btnReload: document.getElementById('btnReload'),
        errBox: document.getElementById('errBox'),
        mainWrap: document.getElementById('mainWrap'),
        boxQr: document.getElementById('boxQr'),
        btnPrintQr: document.getElementById('btnPrintQr'),
        summaryChips: document.getElementById('summaryChips'),
        docsWrap: document.getElementById('docsWrap'),
        btnPrintList: document.getElementById('btnPrintList')
      };

      function showError(message) {
        var msg = C.safeTrim(message || '');
        if (!msg) {
          els.errBox.classList.add('hidden');
          els.errBox.textContent = '';
          return;
        }
        els.errBox.textContent = msg;
        els.errBox.classList.remove('hidden');
      }

      function statusBadge(status, storedLoc) {
        var st = C.safeTrim(status || '');
        if (st === 'ยกเลิก') return '<span class="badge err">ยกเลิก</span>';
        if (st === 'อนุมัติแล้วส่งคืนเจ้าของเรื่อง') return '<span class="badge">ส่งคืนฯ</span>';
        if (st === 'กำลังดำเนินการ') return '<span class="badge info">กำลังดำเนินการ</span>';
        if (st === 'มอบผู้รับผิดชอบ') return '<span class="badge" style="background:rgba(236,72,153,.12);border-color:rgba(236,72,153,.45);color:#9d174d;">มอบผู้รับผิดชอบ</span>';
        if (C.safeTrim(storedLoc || '')) return '<span class="badge ok">จัดเก็บแล้ว</span>';
        return '<span class="badge warn">รอจัดเก็บ</span>';
      }

      function getBoxQrTarget() {
        var base = C.normalizeScriptUrl(state.settings.scriptUrl || '').split('?')[0];
        return base + '?box=' + encodeURIComponent(state.detail.boxName || boxName) + '&dk=' + encodeURIComponent(state.settings.deviceKey || '');
      }

      function getBoxQrImage() {
        return 'https://api.qrserver.com/v1/create-qr-code/?size=900x900&margin=10&ecc=Q&data=' + encodeURIComponent(getBoxQrTarget());
      }

      function goDoc(docId) {
        C.redirect('doc-view.html', { id: docId });
      }

      function render() {
        var detail = state.detail || {};
        var docs = Array.isArray(detail.docs) ? detail.docs : [];

        els.boxHead.textContent = (detail.boxName || boxName || '-') + ' | ' + docs.length + ' รายการ';
        els.boxQr.src = getBoxQrImage();

        els.summaryChips.innerHTML = ''
          + '<span class="chip"><i class="bi bi-archive"></i> กล่อง: ' + C.escapeHtml(detail.boxName || '-') + '</span>'
          + '<span class="chip"><i class="bi bi-files"></i> เอกสารรวม: ' + docs.length + ' รายการ</span>'
          + '<span class="chip"><i class="bi bi-calendar3"></i> ปีจัดเก็บ: ' + C.escapeHtml(detail.storageYearSummary || '-') + '</span>'
          + '<span class="chip warn"><i class="bi bi-clock-history"></i> ปีที่ทำลาย: ' + C.escapeHtml(detail.destroyYearSummary || '-') + '</span>';

        if (!docs.length) {
          els.docsWrap.innerHTML = '<div class="empty">ไม่พบเอกสารในกล่องนี้</div>';
          return;
        }

        var html = '';
        for (var i = 0; i < docs.length; i++) {
          var d = docs[i] || {};
          var title = C.safeTrim(d.amDocNo || '') || C.safeTrim(d.docId || '-') || '-';
          var sub = C.safeTrim(d.docNoSdh || '');
          var subject = C.safeTrim(d.subject || '-') || '-';
          var sender = C.safeTrim(d.sender || '-') || '-';
          var group = C.safeTrim(d.group || '-') || '-';
          var fiscal = C.safeTrim(d.fiscal || '-') || '-';
          var receiveNo = C.safeTrim(d.receiveNo || '-') || '-';
          var storedDate = C.safeTrim(d.dateStr || '-') || '-';
          var user = C.safeTrim(d.user || '-') || '-';

          html += '<div class="doc-card" data-doc="' + C.escapeHtml(d.docId || '') + '">';
          html += '<div class="doc-top">';
          html += '<div>';
          html += '<div class="doc-title">' + C.escapeHtml(title) + '</div>';
          if (sub && sub !== title) html += '<div class="doc-sub">สธ ' + C.escapeHtml(sub) + '</div>';
          html += '</div>';
          html += '<div class="actions">';
          html += '<span class="badge" style="background:rgba(37,99,235,.12);border-color:rgba(37,99,235,.45);color:#1d4ed8;">ปี ' + C.escapeHtml(fiscal) + '</span>';
          html += statusBadge(d.status, d.storedLoc || '');
          html += '</div>';
          html += '</div>';

          html += '<div class="doc-subject">' + C.escapeHtml(subject) + '</div>';

          html += '<div class="doc-foot">';
          html += '<div><i class="bi bi-person me-1"></i>' + C.escapeHtml(sender) + ' <span class="muted">(' + C.escapeHtml(group) + ')</span></div>';
          html += '<div><span class="muted">รับ:</span> ' + C.escapeHtml(receiveNo) + ' | <span class="muted">จัดเก็บ:</span> ' + C.escapeHtml(storedDate) + ' | <span class="muted">ผู้จัดเก็บ:</span> ' + C.escapeHtml(user) + '</div>';
          html += '</div>';

          html += '</div>';
        }

        els.docsWrap.innerHTML = html;

        var cards = els.docsWrap.querySelectorAll('.doc-card');
        for (var c = 0; c < cards.length; c++) {
          cards[c].addEventListener('click', function () {
            var id = C.safeTrim(this.getAttribute('data-doc') || '');
            if (id) goDoc(id);
          });
        }
      }

      function printBoxQr() {
        var w = window.open('', '', 'width=920,height=700');
        if (!w) {
          Swal.fire('ไม่สามารถเปิดหน้าต่างพิมพ์', 'กรุณาอนุญาต Pop-up', 'info');
          return;
        }

        var esc = C.escapeHtml;
        var qr = getBoxQrImage();
        var d = state.detail || {};

        var h = '';
        h += '<!doctype html><html><head><meta charset="utf-8"><title>QR กล่อง</title>';
        h += '<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Thai:wght@400;600;700;800&display=swap" rel="stylesheet">';
        h += '<style>@page{size:A4 landscape;margin:10mm}body{font-family:"IBM Plex Sans Thai",sans-serif;margin:0;padding:0;color:#111}.sheet{width:calc(297mm - 20mm);height:calc(210mm - 20mm);margin:0 auto;display:flex;flex-direction:column;justify-content:center;align-items:center;gap:8mm}.qr{width:84mm;height:84mm;border:3px solid #111;border-radius:20px;padding:3px;background:#fff;object-fit:contain}.name{font-size:42pt;font-weight:900;line-height:1.08;text-align:center}.chips{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}.chip{padding:8px 14px;border-radius:999px;border:1.5px solid #111;font-size:14pt;font-weight:700}.chip.warn{border-color:#b91c1c;color:#991b1b;background:#fef2f2}.no-print{text-align:center;margin-top:10px}@media print{.no-print{display:none!important}}</style>';
        h += '</head><body><div class="sheet">';
        h += '<img class="qr" src="' + esc(qr) + '">';
        h += '<div class="name">' + esc(d.boxName || boxName || '-') + '</div>';
        h += '<div class="chips"><span class="chip">ปีจัดเก็บเอกสาร: ' + esc(d.storageYearSummary || '-') + '</span><span class="chip warn">ปีที่ทำลาย: ' + esc(d.destroyYearSummary || '-') + '</span></div>';
        h += '<div class="no-print"><button onclick="window.print()" style="padding:10px 26px;border:none;border-radius:999px;background:#2563eb;color:#fff;font-weight:800">พิมพ์</button></div>';
        h += '</div></body></html>';

        w.document.write(h);
        w.document.close();
      }

      function printList() {
        var d = state.detail || {};
        var docs = Array.isArray(d.docs) ? d.docs : [];
        if (!docs.length) {
          Swal.fire('ไม่มีข้อมูล', 'ไม่พบเอกสารสำหรับพิมพ์', 'warning');
          return;
        }

        var w = window.open('', '', 'width=1220,height=820');
        if (!w) {
          Swal.fire('ไม่สามารถเปิดหน้าต่างพิมพ์', 'กรุณาอนุญาต Pop-up', 'info');
          return;
        }

        var esc = C.escapeHtml;
        var h = '';
        h += '<!doctype html><html><head><meta charset="utf-8"><title>รายการเอกสารในกล่อง</title>';
        h += '<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Thai:wght@400;500;700&display=swap" rel="stylesheet">';
        h += '<style>@page{size:A4 landscape;margin:8mm}body{font-family:"IBM Plex Sans Thai",sans-serif;margin:0;padding:8px;color:#0f172a}h2{margin:0 0 2px;text-align:center;font-size:21px;font-weight:800}p.meta{margin:0 0 8px;text-align:center;font-size:11px;color:#334155}table{width:100%;border-collapse:collapse;table-layout:fixed}th,td{border:1px solid #334155;padding:4px 5px;font-size:10.2px;line-height:1.28;vertical-align:top}th{background:#e2e8f0;text-align:center;font-weight:800}.text-center{text-align:center}.text-right{text-align:right}.subject,.sender,.user{white-space:normal;overflow-wrap:anywhere;word-break:break-word}@media print{button{display:none!important}}</style>';
        h += '</head><body>';
        h += '<h2>รายการเอกสารในกล่อง: ' + esc(d.boxName || boxName || '-') + '</h2>';
        h += '<p class="meta">ข้อมูล ณ วันที่ ' + esc(new Date().toLocaleString('th-TH')) + ' | จำนวนทั้งหมด ' + docs.length + ' รายการ</p>';
        h += '<table><thead><tr><th style="width:4%">ลำดับ</th><th style="width:5%">ปีงบฯ</th><th style="width:10%">เลขที่หนังสือส่งกองคลัง</th><th style="width:8%">เลขที่ สธ.</th><th style="width:24%">ชื่อเรื่อง</th><th style="width:11%">ชื่อผู้ส่ง</th><th style="width:8%">จำนวน</th><th style="width:8%">ส่วนต่าง</th><th style="width:11%">วันที่จัดเก็บ</th><th style="width:11%">ผู้จัดเก็บ</th></tr></thead><tbody>';

        for (var i = 0; i < docs.length; i++) {
          var row = docs[i] || {};
          var subject = C.safeText(row.subject || '-');
          if (subject.length > 240) subject = subject.substring(0, 240).replace(/\s+$/, '') + '...';
          var dateText = C.safeText(row.dateStr || '-') + (C.safeTrim(row.timeStr || '') ? (' ' + C.safeTrim(row.timeStr || '')) : '');
          h += '<tr>';
          h += '<td class="text-center">' + (i + 1) + '</td>';
          h += '<td class="text-center">' + esc(row.fiscal || '-') + '</td>';
          h += '<td class="text-center">' + esc(row.amDocNo || '') + '</td>';
          h += '<td class="text-center">' + esc(row.docNoSdh || '') + '</td>';
          h += '<td class="subject">' + esc(subject) + '</td>';
          h += '<td class="sender">' + esc(row.sender || '-') + '</td>';
          h += '<td class="text-right">' + esc(row.amount || '-') + '</td>';
          h += '<td class="text-right">' + esc(row.difference || '-') + '</td>';
          h += '<td class="text-center">' + esc(dateText) + '</td>';
          h += '<td class="user">' + esc(row.user || '-') + '</td>';
          h += '</tr>';
        }

        h += '</tbody></table>';
        h += '<script>window.onload=function(){window.print();window.close();}<\/script>';
        h += '</body></html>';

        w.document.write(h);
        w.document.close();
      }

      async function loadDetail() {
        showError('');
        els.mainWrap.classList.add('hidden');

        try {
          var data = await Promise.all([
            state.api.boxDetail(boxName),
            state.api.me()
          ]);

          var boxRes = data[0] || {};
          var meRes = data[1] || {};

          if (!meRes || meRes.success === false || !meRes.user) {
            C.redirect('index.html', {}, true);
            return;
          }

          if (!boxRes || boxRes.success === false) {
            throw new Error((boxRes && boxRes.error) ? boxRes.error : 'ไม่พบข้อมูลกล่อง');
          }

          state.user = meRes.user;
          state.detail = boxRes;

          render();
          els.mainWrap.classList.remove('hidden');
        } catch (err) {
          showError((err && err.message) ? err.message : 'โหลดข้อมูลกล่องไม่สำเร็จ');
        }
      }

      function init() {
        if (!boxName) {
          showError('ไม่พบพารามิเตอร์ box');
          return;
        }

        try {
          state.settings = C.ensureSettingsOrThrow();
          state.api = C.createApiClient(state.settings);
        } catch (_e) {
          showError('กรุณาตั้งค่า scriptUrl และ deviceKey ที่หน้า index ก่อน');
          return;
        }

        els.btnBack.onclick = function () {
          if (window.history.length > 1) {
            window.history.back();
          } else {
            C.redirect('index.html');
          }
        };

        els.btnReload.onclick = function () { loadDetail(); };
        els.btnPrintQr.onclick = function () { printBoxQr(); };
        els.btnPrintList.onclick = function () { printList(); };

        loadDetail();
      }

      init();
    })();
  </script>
</body>
</html>
