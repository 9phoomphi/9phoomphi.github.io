<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>รายละเอียดเอกสาร</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Thai:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    :root {
      --bg: #f3f6fb;
      --card: rgba(255,255,255,0.9);
      --text: #0f172a;
      --muted: #475569;
      --border: #dbe4f0;
      --primary: #2563eb;
      --primary2: #1d4ed8;
      --success: #16a34a;
      --danger: #dc2626;
      --warn: #d97706;
      --shadow: 0 18px 46px rgba(15,23,42,0.14);
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "IBM Plex Sans Thai", sans-serif;
      color: var(--text);
      background: radial-gradient(1200px 540px at 8% -14%, rgba(59,130,246,0.22), rgba(59,130,246,0)), var(--bg);
    }

    .shell { max-width: 1080px; margin: 0 auto; padding: 14px; }
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 18px;
      box-shadow: var(--shadow);
      padding: 14px;
      margin-bottom: 12px;
      backdrop-filter: saturate(160%) blur(8px);
    }

    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .title { margin: 0; font-size: 1.1rem; font-weight: 800; }
    .muted { color: var(--muted); }

    .btn {
      border: none;
      border-radius: 999px;
      height: 38px;
      padding: 0 14px;
      color: #fff;
      font: inherit;
      font-weight: 700;
      cursor: pointer;
      background: linear-gradient(180deg, var(--primary), var(--primary2));
    }
    .btn.secondary { background: #334155; }
    .btn.success { background: #15803d; }
    .btn.warn { background: #d97706; }
    .btn.danger { background: #dc2626; }
    .btn.outline {
      background: #fff;
      color: var(--primary2);
      border: 1px solid #93c5fd;
    }

    .actions { display: flex; gap: 8px; flex-wrap: wrap; }
    .grid-2 { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 10px; }
    .grid-3 { display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 10px; }

    .label { font-size: 0.78rem; color: var(--muted); font-weight: 700; margin-bottom: 2px; }
    .value { font-size: 0.95rem; font-weight: 600; line-height: 1.35; word-break: break-word; }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border-radius: 999px;
      padding: 5px 10px;
      font-size: 0.75rem;
      font-weight: 800;
      border: 1px solid var(--border);
      background: #eef4ff;
      color: #334155;
    }

    .badge.ok { color: #166534; border-color: rgba(22,163,74,.45); background: rgba(22,163,74,.13); }
    .badge.warn { color: #92400e; border-color: rgba(217,119,6,.45); background: rgba(217,119,6,.12); }
    .badge.err { color: #991b1b; border-color: rgba(220,38,38,.45); background: rgba(220,38,38,.12); }
    .badge.info { color: #075985; border-color: rgba(14,165,233,.45); background: rgba(14,165,233,.12); }

    .step-track {
      display: grid;
      grid-template-columns: repeat(5, minmax(0, 1fr));
      gap: 8px;
    }
    .step {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 8px;
      text-align: center;
      background: #f8fbff;
    }
    .step.done {
      border-color: rgba(22,163,74,.45);
      background: rgba(22,163,74,.12);
      color: #166534;
    }

    input, select, textarea {
      width: 100%;
      border: 1px solid var(--border);
      border-radius: 10px;
      min-height: 40px;
      padding: 8px 10px;
      font: inherit;
      color: var(--text);
      background: #fff;
    }

    .row { display: grid; gap: 10px; }
    .row.two { grid-template-columns: repeat(2, minmax(0, 1fr)); }

    .avatar-chip {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 4px 10px 4px 4px;
      background: #f8fbff;
      font-size: 0.8rem;
      font-weight: 700;
      color: #334155;
      max-width: 100%;
    }
    .avatar-chip img {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      object-fit: cover;
      border: 1px solid rgba(37,99,235,.35);
      flex-shrink: 0;
    }
    .avatar-chip span { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

    .error {
      border: 1px solid rgba(220,38,38,.35);
      background: rgba(220,38,38,.08);
      color: #991b1b;
      border-radius: 10px;
      padding: 10px;
      font-size: 0.9rem;
    }

    .hidden { display: none !important; }

    @media (max-width: 900px) {
      .grid-2, .grid-3, .row.two { grid-template-columns: 1fr; }
      .step-track { grid-template-columns: 1fr 1fr; }
    }
  </style>
</head>
<body>
  <div class="shell">
    <div class="card topbar">
      <div>
        <h1 class="title">รายละเอียดเอกสาร</h1>
        <div id="docHead" class="muted" style="font-size:0.84rem">กำลังโหลด...</div>
      </div>
      <div class="actions">
        <button id="btnBack" class="btn secondary" type="button"><i class="bi bi-arrow-left"></i> กลับ</button>
        <button id="btnReload" class="btn outline" type="button"><i class="bi bi-arrow-clockwise"></i> โหลดใหม่</button>
      </div>
    </div>

    <div id="errBox" class="error hidden"></div>

    <div id="mainWrap" class="hidden">
      <div class="card">
        <div class="actions" id="statusBadges"></div>
      </div>

      <div class="card">
        <div class="grid-3" id="baseInfo"></div>
      </div>

      <div class="card">
        <div class="label">เรื่อง</div>
        <div id="subjectText" class="value" style="font-size:1rem;"></div>
        <div class="grid-3" id="detailInfo" style="margin-top:8px;"></div>
      </div>

      <div class="card">
        <div class="topbar" style="margin-bottom:8px;">
          <div class="label" style="font-size:0.9rem;color:#334155">เลขที่หนังสือส่งกองคลัง / ลงวันที่ดำเนินการ</div>
          <div class="actions" id="fieldActions"></div>
        </div>
        <div class="grid-2" id="docNoInfo"></div>
      </div>

      <div class="card">
        <div class="label" style="font-size:0.9rem;color:#334155">ขั้นตอนดำเนินการ</div>
        <div id="stepTrack" class="step-track"></div>
      </div>

      <div class="card" id="storageWrap"></div>

      <div class="card" id="actionWrap"></div>

      <div class="card" style="text-align:center;">
        <div class="label">QR เอกสาร</div>
        <img id="docQr" alt="QR" style="width:min(72vw,260px);max-width:260px;aspect-ratio:1/1;border:1px solid var(--border);border-radius:12px;padding:4px;background:#fff;object-fit:contain;image-rendering:pixelated;">
        <div class="actions" style="justify-content:center;margin-top:8px;">
          <button id="btnPrintSticker" class="btn outline" type="button"><i class="bi bi-printer"></i> พิมพ์ใบแปะ</button>
        </div>
      </div>
    </div>
  </div>

  <script src="./config.js"></script>
  <script src="./api-client.js"></script>
  <script src="./app-common.js"></script>
  <script>
    (function () {
      'use strict';

      var C = window.DocFrontendCommon;
      var query = C.parseQuery();
      var docId = C.safeTrim(query.id || '');

      var state = {
        api: null,
        settings: null,
        user: null,
        doc: null,
        statusData: null,
        info: null,
        memberMap: {}
      };

      var els = {
        docHead: document.getElementById('docHead'),
        btnBack: document.getElementById('btnBack'),
        btnReload: document.getElementById('btnReload'),
        errBox: document.getElementById('errBox'),
        mainWrap: document.getElementById('mainWrap'),
        statusBadges: document.getElementById('statusBadges'),
        baseInfo: document.getElementById('baseInfo'),
        subjectText: document.getElementById('subjectText'),
        detailInfo: document.getElementById('detailInfo'),
        docNoInfo: document.getElementById('docNoInfo'),
        fieldActions: document.getElementById('fieldActions'),
        stepTrack: document.getElementById('stepTrack'),
        storageWrap: document.getElementById('storageWrap'),
        actionWrap: document.getElementById('actionWrap'),
        docQr: document.getElementById('docQr'),
        btnPrintSticker: document.getElementById('btnPrintSticker')
      };

      function showError(message) {
        var msg = C.safeTrim(message || '');
        if (!msg) {
          els.errBox.classList.add('hidden');
          els.errBox.textContent = '';
          return;
        }
        els.errBox.textContent = msg;
        els.errBox.classList.remove('hidden');
      }

      function statusBadge(doc) {
        var st = C.safeTrim(doc.docStatus || '');
        if (st === 'ยกเลิก') return '<span class="badge err"><i class="bi bi-x-circle"></i> ยกเลิก</span>';
        if (st === 'อนุมัติแล้วส่งคืนเจ้าของเรื่อง') return '<span class="badge"><i class="bi bi-arrow-return-left"></i> ส่งคืนฯ</span>';
        if (st === 'กำลังดำเนินการ') return '<span class="badge info"><i class="bi bi-hourglass-split"></i> กำลังดำเนินการ</span>';
        if (st === 'มอบผู้รับผิดชอบ') return '<span class="badge" style="background:rgba(236,72,153,.12);border-color:rgba(236,72,153,.45);color:#9d174d;"><i class="bi bi-person-check"></i> มอบผู้รับผิดชอบ</span>';
        return '<span class="badge ok"><i class="bi bi-check-circle"></i> ดำเนินการเสร็จ</span>';
      }

      function renderUserChip(name) {
        var key = C.safeTrim(name || '');
        if (!key) return '-';
        var img = state.memberMap[key] || state.memberMap[key.toLowerCase()] || '';
        if (!img) {
          return '<span class="avatar-chip"><img alt="u" src="https://dummyimage.com/24x24/e2e8f0/64748b.png&text=' + encodeURIComponent((key.charAt(0) || '?').toUpperCase()) + '"><span>' + C.escapeHtml(key) + '</span></span>';
        }
        return '<span class="avatar-chip"><img alt="u" src="' + C.escapeHtml(img) + '"><span>' + C.escapeHtml(key) + '</span></span>';
      }

      function getDocQrUrl() {
        var base = C.normalizeScriptUrl(state.settings.scriptUrl || '').split('?')[0];
        var target = base + '?id=' + encodeURIComponent(state.doc.docId || docId) + '&dk=' + encodeURIComponent(state.settings.deviceKey || '');
        return 'https://api.qrserver.com/v1/create-qr-code/?size=1000x1000&margin=0&qzone=2&ecc=Q&data=' + encodeURIComponent(target);
      }

      function renderDoc() {
        var d = state.doc || {};
        var statusData = state.statusData || {};
        var isReadOnly = !!d.isReadOnlyUser;
        var isStored = !!d.isStored;

        els.docHead.textContent = (d.docId || '-') + ' | เลขรับ ' + (d.receiveNo || '-');

        var badges = statusBadge(d);
        if (isStored) {
          badges += ' <span class="badge ok"><i class="bi bi-archive"></i> จัดเก็บแล้ว</span>';
        } else {
          badges += ' <span class="badge warn"><i class="bi bi-clock-history"></i> รอจัดเก็บ</span>';
        }
        els.statusBadges.innerHTML = badges;

        var baseRows = [
          ['เลขที่รับ', d.receiveNo || '-'],
          ['วันที่รับ', d.dateRecDisplay || '-'],
          ['เวลา', (d.timeRec || '-') + ' น.'],
          ['เลขที่ สธ.', d.docNoSdh || '-'],
          ['ประเภทเงินงบประมาณ', d.budgetType || '-'],
          ['ปีงบประมาณ', d.fiscalYear || '-']
        ];

        var baseHtml = '';
        for (var i = 0; i < baseRows.length; i++) {
          baseHtml += '<div><div class="label">' + C.escapeHtml(baseRows[i][0]) + '</div><div class="value">' + C.escapeHtml(baseRows[i][1]) + '</div></div>';
        }
        els.baseInfo.innerHTML = baseHtml;

        els.subjectText.textContent = d.subject || '-';

        var detailRows = [
          ['กลุ่ม/ศูนย์', d.group || '-'],
          ['ผู้ส่ง', d.sender || '-'],
          ['วัตถุประสงค์', d.purpose || '-'],
          ['จำนวน', C.fmtMoney(d.amount)],
          ['ส่วนต่าง', C.fmtMoney(d.difference)],
          ['หมายเหตุ', d.statusRemark || '-']
        ];
        var detailHtml = '';
        for (var j = 0; j < detailRows.length; j++) {
          detailHtml += '<div><div class="label">' + C.escapeHtml(detailRows[j][0]) + '</div><div class="value">' + C.escapeHtml(detailRows[j][1]) + '</div></div>';
        }
        els.detailInfo.innerHTML = detailHtml;

        els.docNoInfo.innerHTML = ''
          + '<div><div class="label">เลขที่หนังสือส่งกองคลัง</div><div class="value">' + C.escapeHtml(d.amDocNo || '-') + '</div></div>'
          + '<div><div class="label">ลงวันที่ดำเนินการ</div><div class="value">' + C.escapeHtml(d.anDateDisplay || '-') + '</div></div>';

        var fieldButtons = '';
        if (!isReadOnly) {
          fieldButtons += '<button id="btnEditAm" class="btn outline" type="button"><i class="bi bi-pencil"></i> แก้เลขหนังสือ</button>';
          fieldButtons += '<button id="btnEditAn" class="btn outline" type="button"><i class="bi bi-calendar3"></i> แก้วันที่</button>';
        }
        els.fieldActions.innerHTML = fieldButtons;

        var steps = [
          ['ส่งกลับแก้ไข', statusData.returnCheck, statusData.returnDateDisplay, statusData.returnUser],
          ['รับคืนเอกสาร', statusData.receiveBackCheck, statusData.receiveBackDateDisplay, statusData.receiveBackUser],
          ['ตรวจสอบ', statusData.verifyCheck, statusData.verifyDateDisplay, statusData.verifyUser],
          ['หัวหน้าผ่านงาน', statusData.bossCheck, statusData.bossDateDisplay, statusData.bossUser],
          ['เสนอลงนาม', statusData.signCheck, statusData.signDateDisplay, statusData.signUser]
        ];

        var stepHtml = '';
        for (var k = 0; k < steps.length; k++) {
          var done = !!steps[k][1];
          stepHtml += '<div class="step ' + (done ? 'done' : '') + '">';
          stepHtml += '<div style="font-weight:800;font-size:.8rem;">' + C.escapeHtml(steps[k][0]) + '</div>';
          if (done) {
            stepHtml += '<div style="font-size:.72rem;margin-top:3px;">' + C.escapeHtml(steps[k][2] || '-') + '</div>';
            stepHtml += '<div style="font-size:.72rem;">' + C.escapeHtml(steps[k][3] || '-') + '</div>';
          } else {
            stepHtml += '<div style="font-size:.72rem;margin-top:3px;color:#64748b;">ยังไม่ดำเนินการ</div>';
          }
          stepHtml += '</div>';
        }
        els.stepTrack.innerHTML = stepHtml;

        if (isStored) {
          els.storageWrap.innerHTML = ''
            + '<div class="label" style="font-size:.9rem;color:#334155">ข้อมูลการจัดเก็บ</div>'
            + '<div class="grid-2" style="margin-top:8px;">'
            + '<div><div class="label">สถานที่เก็บ</div><div class="value">' + C.escapeHtml(d.storedLoc || '-') + '</div></div>'
            + '<div><div class="label">ผู้จัดเก็บ</div><div class="value">' + renderUserChip(d.storedUser || '-') + '</div></div>'
            + '<div><div class="label">วันที่จัดเก็บ</div><div class="value">' + C.escapeHtml(d.storedAtDisplay || '-') + '</div></div>'
            + '<div><div class="label">ครบกำหนดทำลาย</div><div class="value">' + C.escapeHtml(d.destroyDateDisplay || '-') + '</div></div>'
            + '</div>';
        } else {
          var locOpts = '<option value="">เลือกสถานที่เก็บ...</option>';
          var fyOpts = '<option value="">เลือกปีงบประมาณ...</option>';
          var info = (state.info && state.info.data) ? state.info.data : { locations: [], fiscalYears: [] };
          var locations = Array.isArray(info.locations) ? info.locations : [];
          var fYears = Array.isArray(info.fiscalYears) ? info.fiscalYears : [];
          for (var li = 0; li < locations.length; li++) {
            locOpts += '<option value="' + C.escapeHtml(locations[li]) + '">' + C.escapeHtml(locations[li]) + '</option>';
          }
          for (var fi = 0; fi < fYears.length; fi++) {
            fyOpts += '<option value="' + C.escapeHtml(fYears[fi]) + '">' + C.escapeHtml(fYears[fi]) + '</option>';
          }

          var canStore = !isReadOnly && d.docStatus !== 'ยกเลิก' && d.docStatus !== 'อนุมัติแล้วส่งคืนเจ้าของเรื่อง' && d.docStatus !== 'กำลังดำเนินการ' && d.docStatus !== 'มอบผู้รับผิดชอบ';
          if (!canStore) {
            els.storageWrap.innerHTML = '<div class="muted">เอกสารสถานะนี้ยังไม่สามารถจัดเก็บได้</div>';
          } else {
            els.storageWrap.innerHTML = ''
              + '<div class="label" style="font-size:.9rem;color:#334155">บันทึกการจัดเก็บ</div>'
              + '<div class="row two" style="margin-top:8px;">'
              + '<div><div class="label">สถานที่จัดเก็บ</div><select id="storageLoc">' + locOpts + '</select></div>'
              + '<div><div class="label">ปีงบประมาณ</div><select id="storageFiscal">' + fyOpts + '</select></div>'
              + '</div>'
              + '<div class="actions" style="margin-top:8px;">'
              + '<button id="btnSaveStorage" class="btn success" type="button"><i class="bi bi-save"></i> บันทึกจัดเก็บ</button>'
              + '</div>';
          }
        }

        var actionHtml = '<div class="actions">';
        if (!isReadOnly) {
          actionHtml += '<button id="btnEdit" class="btn outline" type="button"><i class="bi bi-pencil"></i> แก้ไขเอกสาร</button>';
          actionHtml += '<button id="btnStatus" class="btn outline" type="button"><i class="bi bi-list-check"></i> จัดการสถานะ</button>';
          actionHtml += '<button id="btnMainStatus" class="btn warn" type="button"><i class="bi bi-arrow-repeat"></i> เปลี่ยนสถานะหลัก</button>';
        }
        actionHtml += '</div>';
        els.actionWrap.innerHTML = actionHtml;

        els.docQr.src = getDocQrUrl();

        bindActionEvents();
      }

      function bindActionEvents() {
        var d = state.doc || {};

        var btnEdit = document.getElementById('btnEdit');
        if (btnEdit) {
          btnEdit.onclick = function () {
            C.redirect('add-edit.html', { mode: 'edit', id: d.docId });
          };
        }

        var btnStatus = document.getElementById('btnStatus');
        if (btnStatus) {
          btnStatus.onclick = function () {
            C.redirect('status.html', { id: d.docId });
          };
        }

        var btnMainStatus = document.getElementById('btnMainStatus');
        if (btnMainStatus) {
          btnMainStatus.onclick = changeMainStatus;
        }

        var btnSaveStorage = document.getElementById('btnSaveStorage');
        if (btnSaveStorage) {
          btnSaveStorage.onclick = saveStorageData;
        }

        var btnEditAm = document.getElementById('btnEditAm');
        if (btnEditAm) {
          btnEditAm.onclick = function () { editField('amDocNo', 'แก้ไขเลขที่หนังสือส่งกองคลัง', d.amDocNo || ''); };
        }

        var btnEditAn = document.getElementById('btnEditAn');
        if (btnEditAn) {
          btnEditAn.onclick = function () { editField('anDate', 'แก้ไขลงวันที่ดำเนินการ (YYYY-MM-DD)', d.anDateInput || ''); };
        }
      }

      function calcDestroyDateYmd() {
        var now = new Date();
        var d = new Date(now.getFullYear() + 10, now.getMonth(), now.getDate());
        var m = String(d.getMonth() + 1).padStart(2, '0');
        var day = String(d.getDate()).padStart(2, '0');
        return d.getFullYear() + '-' + m + '-' + day;
      }

      async function saveStorageData() {
        var locEl = document.getElementById('storageLoc');
        var fyEl = document.getElementById('storageFiscal');
        var loc = C.safeTrim(locEl ? locEl.value : '');
        var fy = C.safeTrim(fyEl ? fyEl.value : '');
        if (!loc || !fy) {
          Swal.fire('กรอกข้อมูลไม่ครบ', 'กรุณาเลือกสถานที่จัดเก็บและปีงบประมาณ', 'warning');
          return;
        }

        try {
          var res = await state.api.saveStorageData(state.doc.docId, loc, '', fy, calcDestroyDateYmd());
          if (!res || res.success === false) throw new Error((res && res.error) ? res.error : 'บันทึกไม่สำเร็จ');
          Swal.fire('บันทึกสำเร็จ', 'จัดเก็บเอกสารเรียบร้อย', 'success');
          await loadDetail();
        } catch (err) {
          Swal.fire('เกิดข้อผิดพลาด', (err && err.message) ? err.message : 'บันทึกไม่สำเร็จ', 'error');
        }
      }

      async function changeMainStatus() {
        var result = await Swal.fire({
          title: 'เปลี่ยนสถานะเอกสาร',
          html: ''
            + '<div style="text-align:left;">'
            + '<label class="label">สถานะ</label>'
            + '<select id="swMainStatus">'
            + '<option value="">-- เลือกสถานะ --</option>'
            + '<option value="ดำเนินการเสร็จ">ดำเนินการเสร็จ</option>'
            + '<option value="กำลังดำเนินการ">กำลังดำเนินการ</option>'
            + '<option value="มอบผู้รับผิดชอบ">มอบผู้รับผิดชอบ</option>'
            + '<option value="ยกเลิก">ยกเลิก</option>'
            + '<option value="อนุมัติแล้วส่งคืนเจ้าของเรื่อง">อนุมัติแล้วส่งคืนเจ้าของเรื่อง</option>'
            + '</select>'
            + '<label class="label" style="margin-top:8px;">หมายเหตุ (ไม่บังคับ)</label>'
            + '<textarea id="swMainRemark" rows="3" placeholder="หมายเหตุ"></textarea>'
            + '</div>',
          showCancelButton: true,
          confirmButtonText: 'บันทึก',
          cancelButtonText: 'ยกเลิก',
          preConfirm: function () {
            var st = C.safeTrim(document.getElementById('swMainStatus').value);
            if (!st) {
              Swal.showValidationMessage('กรุณาเลือกสถานะ');
              return false;
            }
            return {
              status: st,
              remark: C.safeTrim(document.getElementById('swMainRemark').value)
            };
          }
        });

        if (!result || !result.isConfirmed || !result.value) return;

        try {
          var res = await state.api.docChangeMainStatus(state.doc.docId, result.value.status, result.value.remark);
          if (!res || res.success === false) throw new Error((res && res.error) ? res.error : 'บันทึกไม่สำเร็จ');
          Swal.fire('สำเร็จ', 'เปลี่ยนสถานะเรียบร้อย', 'success');
          await loadDetail();
        } catch (err) {
          Swal.fire('เกิดข้อผิดพลาด', (err && err.message) ? err.message : 'บันทึกไม่สำเร็จ', 'error');
        }
      }

      async function editField(fieldName, title, currentValue) {
        var result = await Swal.fire({
          title: title,
          input: 'text',
          inputValue: C.safeText(currentValue || ''),
          showCancelButton: true,
          confirmButtonText: 'บันทึก',
          cancelButtonText: 'ยกเลิก'
        });

        if (!result || !result.isConfirmed) return;

        try {
          var res = await state.api.docUpdateField(state.doc.docId, fieldName, C.safeText(result.value || ''));
          if (!res || res.success === false) throw new Error((res && res.error) ? res.error : 'บันทึกไม่สำเร็จ');
          Swal.fire('สำเร็จ', 'บันทึกข้อมูลเรียบร้อย', 'success');
          await loadDetail();
        } catch (err) {
          Swal.fire('เกิดข้อผิดพลาด', (err && err.message) ? err.message : 'บันทึกไม่สำเร็จ', 'error');
        }
      }

      function printSticker() {
        var d = state.doc || {};
        var qr = getDocQrUrl();
        var w = window.open('', '', 'width=920,height=1200');
        if (!w) {
          Swal.fire('ไม่สามารถเปิดหน้าต่างพิมพ์', 'กรุณาอนุญาต Pop-up', 'info');
          return;
        }

        var esc = C.escapeHtml;
        var h = '';
        h += '<!doctype html><html><head><meta charset="utf-8"><title>ใบแปะเอกสาร</title>';
        h += '<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Thai:wght@400;500;700;800&display=swap" rel="stylesheet">';
        h += '<style>@page{size:A4 portrait;margin:8mm}body{font-family:"IBM Plex Sans Thai",sans-serif;margin:0;padding:0;color:#0f172a}.sheet{max-width:194mm;margin:0 auto}.label{border:2px solid #0f172a;border-radius:16px;padding:10px}table{width:100%;border-collapse:collapse;margin-top:10px}td{border:1px solid #cbd5e1;padding:6px 8px;font-size:10.5pt}td.head{width:35%;background:#f8fafc;font-weight:800;color:#334155}.subj{margin-top:10px;border:1px solid #cbd5e1;border-radius:12px;padding:8px;background:#f8fafc}.no-print{text-align:center;margin-top:10px}@media print{.no-print{display:none!important}}</style>';
        h += '</head><body><div class="sheet"><div class="label">';
        h += '<div style="display:flex;justify-content:space-between;gap:10px;align-items:flex-start"><div><div style="font-size:18pt;font-weight:900">ใบแปะหน้าเอกสาร</div><div style="font-size:10pt;color:#334155">สแกนเพื่อดูรายละเอียดเอกสาร</div></div><img src="' + esc(qr) + '" style="width:48mm;height:48mm;border:1px solid #cbd5e1;border-radius:12px;padding:2px;background:#fff"></div>';
        h += '<table>';
        h += '<tr><td class="head">เลขที่เอกสาร</td><td>' + esc(d.docId || '-') + '</td></tr>';
        h += '<tr><td class="head">เลขที่รับ</td><td>' + esc(d.receiveNo || '-') + '</td></tr>';
        h += '<tr><td class="head">เลขที่ สธ.</td><td>' + esc(d.docNoSdh || '-') + '</td></tr>';
        h += '<tr><td class="head">เลขที่หนังสือส่งกองคลัง</td><td>' + esc(d.amDocNo || '-') + '</td></tr>';
        h += '<tr><td class="head">วันที่รับเอกสาร</td><td>' + esc(d.dateRecDisplay || '-') + '</td></tr>';
        h += '<tr><td class="head">กลุ่ม/ศูนย์</td><td>' + esc(d.group || '-') + '</td></tr>';
        h += '<tr><td class="head">ผู้ส่ง</td><td>' + esc(d.sender || '-') + '</td></tr>';
        h += '<tr><td class="head">วัตถุประสงค์</td><td>' + esc(d.purpose || '-') + '</td></tr>';
        h += '<tr><td class="head">ประเภทเงินงบประมาณ</td><td>' + esc(d.budgetType || '-') + '</td></tr>';
        h += '<tr><td class="head">สถานะ</td><td>' + esc(d.docStatus || '-') + '</td></tr>';
        h += '</table>';
        h += '<div class="subj"><div style="font-size:8pt;font-weight:800;color:#475569">เรื่อง</div><div style="font-size:10.5pt;line-height:1.4">' + esc(d.subject || '-') + '</div></div>';
        h += '</div><div class="no-print"><button onclick="window.print()" style="padding:10px 26px;border:none;border-radius:999px;background:#2563eb;color:#fff;font-weight:800">พิมพ์ใบแปะ</button></div></div></body></html>';

        w.document.write(h);
        w.document.close();
      }

      async function loadDetail() {
        showError('');
        els.mainWrap.classList.add('hidden');

        try {
          var data = await Promise.all([
            state.api.docDetail(docId),
            state.api.optionsMembers(),
            state.api.optionsInfo(),
            state.api.me()
          ]);

          var detailRes = data[0] || {};
          var membersRes = data[1] || {};
          var infoRes = data[2] || {};
          var meRes = data[3] || {};

          if (!meRes || meRes.success === false || !meRes.user) {
            C.redirect('index.html', {}, true);
            return;
          }

          if (!detailRes || detailRes.success === false || !detailRes.doc) {
            throw new Error((detailRes && detailRes.error) ? detailRes.error : 'ไม่พบเอกสาร');
          }

          state.user = meRes.user;
          state.doc = detailRes.doc;
          state.statusData = detailRes.statusData || {};
          state.info = infoRes || { data: { locations: [], fiscalYears: [] } };

          state.memberMap = {};
          var members = (membersRes && membersRes.data && Array.isArray(membersRes.data)) ? membersRes.data : [];
          for (var i = 0; i < members.length; i++) {
            var m = members[i] || {};
            var name = C.safeTrim(m.name || '');
            var img = C.safeTrim(m.image || '');
            if (!name || !img) continue;
            state.memberMap[name] = img;
            state.memberMap[name.toLowerCase()] = img;
          }

          renderDoc();
          els.mainWrap.classList.remove('hidden');
        } catch (err) {
          showError((err && err.message) ? err.message : 'โหลดข้อมูลเอกสารไม่สำเร็จ');
        }
      }

      function init() {
        if (!docId) {
          showError('ไม่พบพารามิเตอร์ id');
          return;
        }

        try {
          state.settings = C.ensureSettingsOrThrow();
          state.api = C.createApiClient(state.settings);
        } catch (_e) {
          showError('กรุณาตั้งค่า scriptUrl และ deviceKey ที่หน้า index ก่อน');
          return;
        }

        els.btnBack.onclick = function () {
          if (window.history.length > 1) {
            window.history.back();
          } else {
            C.redirect('index.html');
          }
        };

        els.btnReload.onclick = function () {
          loadDetail();
        };

        els.btnPrintSticker.onclick = function () {
          printSticker();
        };

        loadDetail();
      }

      init();
    })();
  </script>
</body>
</html>
