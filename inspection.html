<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>เครื่องมือตรวจสอบผลงาน</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Thai:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    :root {
      --bg: #f3f6fb;
      --card: rgba(255,255,255,0.9);
      --text: #0f172a;
      --muted: #475569;
      --border: #dbe4f0;
      --primary: #2563eb;
      --primary2: #1d4ed8;
      --success: #16a34a;
      --shadow: 0 18px 46px rgba(15,23,42,0.14);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "IBM Plex Sans Thai", sans-serif;
      color: var(--text);
      background: radial-gradient(1200px 540px at 8% -14%, rgba(59,130,246,0.22), rgba(59,130,246,0)), var(--bg);
    }

    .shell { max-width: 1080px; margin: 0 auto; padding: 14px; }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 18px;
      box-shadow: var(--shadow);
      padding: 14px;
      margin-bottom: 12px;
      backdrop-filter: saturate(160%) blur(8px);
    }

    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .title { margin: 0; font-size: 1.1rem; font-weight: 800; }
    .muted { color: var(--muted); }

    .btn {
      border: none;
      border-radius: 999px;
      height: 38px;
      padding: 0 14px;
      color: #fff;
      font: inherit;
      font-weight: 700;
      cursor: pointer;
      background: linear-gradient(180deg, var(--primary), var(--primary2));
    }

    .btn.secondary { background: #334155; }
    .btn.outline { background: #fff; color: var(--primary2); border: 1px solid #93c5fd; }
    .btn.success { background: linear-gradient(180deg, #10b981, #0f9f6e); }

    .error {
      border: 1px solid rgba(220,38,38,.35);
      background: rgba(220,38,38,.08);
      color: #991b1b;
      border-radius: 10px;
      padding: 10px;
      font-size: 0.9rem;
    }

    .hidden { display: none !important; }

    .row {
      display: grid;
      gap: 10px;
      grid-template-columns: repeat(4, minmax(0, 1fr));
    }

    .field { display: grid; gap: 4px; }

    .label {
      font-size: 0.78rem;
      color: var(--muted);
      font-weight: 700;
    }

    input, select {
      width: 100%;
      border: 1px solid var(--border);
      border-radius: 10px;
      min-height: 40px;
      padding: 8px 10px;
      font: inherit;
      color: var(--text);
      background: #fff;
    }

    .filters-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 8px;
    }

    .filter-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border-radius: 999px;
      border: 1px solid #93c5fd;
      background: #eff6ff;
      color: #1d4ed8;
      padding: 6px 12px;
      font-size: .78rem;
      font-weight: 700;
    }

    .stat-box {
      border: 1px solid rgba(37,99,235,.24);
      border-radius: 14px;
      background: linear-gradient(135deg, rgba(37,99,235,.10), rgba(37,99,235,.04));
      padding: 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .stat-number {
      font-size: 2.2rem;
      font-weight: 900;
      line-height: 1;
      color: #1d4ed8;
    }

    .doc-item {
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 12px;
      margin-bottom: 8px;
      background: #f8fbff;
      transition: transform .16s ease, box-shadow .2s ease;
      cursor: pointer;
    }

    .doc-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 14px 26px rgba(15,23,42,.12);
    }

    .doc-top {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 6px;
    }

    .doc-title {
      font-size: .96rem;
      font-weight: 800;
      color: #1d4ed8;
      word-break: break-word;
    }

    .doc-sub {
      font-size: .78rem;
      color: #64748b;
    }

    .doc-subject {
      margin: 0 0 8px;
      font-size: .9rem;
      line-height: 1.35;
      color: #0f172a;
    }

    .doc-meta {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      font-size: .78rem;
      color: #475569;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      border-radius: 999px;
      padding: 4px 10px;
      border: 1px solid var(--border);
      background: #eef4ff;
      color: #334155;
      font-size: .72rem;
      font-weight: 800;
    }

    .empty {
      text-align: center;
      color: #64748b;
      font-weight: 600;
      padding: 20px;
    }

    @media (max-width: 960px) {
      .row { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }

    @media (max-width: 640px) {
      .row { grid-template-columns: 1fr; }
      .doc-top { flex-direction: column; }
    }
  </style>
</head>
<body>
  <div class="shell">
    <div class="card topbar">
      <div>
        <h1 class="title">เครื่องมือตรวจสอบผลงาน</h1>
        <div id="pageSub" class="muted" style="font-size:0.84rem">ค้นหาผลงานเจ้าหน้าที่จากขั้นตอนตรวจสอบเอกสาร</div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;">
        <button id="btnBack" class="btn secondary" type="button"><i class="bi bi-arrow-left"></i> กลับ</button>
        <button id="btnReload" class="btn outline" type="button"><i class="bi bi-arrow-clockwise"></i> โหลดใหม่</button>
      </div>
    </div>

    <div id="errBox" class="error hidden"></div>

    <div id="mainWrap" class="hidden">
      <div class="card">
        <div class="row">
          <div class="field">
            <div class="label">เจ้าหน้าที่ *</div>
            <select id="officer"></select>
          </div>
          <div class="field">
            <div class="label">ปีงบประมาณ</div>
            <select id="fiscal"></select>
          </div>
          <div class="field">
            <div class="label">กลุ่ม/ศูนย์</div>
            <select id="group"></select>
          </div>
          <div class="field">
            <div class="label">เวลาเริ่ม-สิ้นสุด</div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
              <input id="startTime" type="time">
              <input id="endTime" type="time">
            </div>
          </div>
        </div>

        <div class="row" style="margin-top:8px;grid-template-columns:repeat(2,minmax(0,1fr));">
          <div class="field">
            <div class="label">วันที่เริ่มต้น</div>
            <input id="startDate" type="date">
          </div>
          <div class="field">
            <div class="label">วันที่สิ้นสุด</div>
            <input id="endDate" type="date">
          </div>
        </div>

        <div class="filters-actions">
          <button id="btnSearch" class="btn" type="button"><i class="bi bi-search"></i> ค้นหา</button>
          <button id="btnReset" class="btn outline" type="button"><i class="bi bi-arrow-counterclockwise"></i> ล้างตัวกรอง</button>
          <span id="activeFilterBadge" class="filter-badge hidden"><i class="bi bi-funnel"></i> 0 ตัวกรอง</span>
        </div>
      </div>

      <div id="statWrap" class="card hidden">
        <div class="stat-box">
          <div>
            <div class="muted" style="font-size:.82rem;font-weight:700;">เอกสารที่ตรวจสอบ</div>
            <div id="statTotal" class="stat-number">0</div>
          </div>
          <div>
            <div id="statOfficer" style="font-weight:800">-</div>
            <div id="statFiscal" class="muted" style="font-size:.82rem">ปีงบประมาณ: ทั้งหมด</div>
            <div id="statDateRange" class="muted" style="font-size:.8rem"></div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="topbar" style="margin-bottom:8px;">
          <div class="title" style="font-size:1rem;">รายการเอกสารที่ตรวจสอบ</div>
          <button id="btnPrint" class="btn success hidden" type="button"><i class="bi bi-printer-fill"></i> พิมพ์รายงาน</button>
        </div>
        <div id="docsWrap" class="empty">เลือกตัวกรองและกดค้นหาเพื่อดูรายงาน</div>
      </div>
    </div>
  </div>

  <script src="./config.js"></script>
  <script src="./api-client.js"></script>
  <script src="./app-common.js"></script>
  <script>
    (function () {
      'use strict';

      var C = window.DocFrontendCommon;

      var state = {
        settings: null,
        api: null,
        user: null,
        options: null,
        members: [],
        docs: [],
        reportMeta: {
          officerName: '',
          fiscalYear: 'ทั้งหมด'
        }
      };

      var els = {
        pageSub: document.getElementById('pageSub'),
        btnBack: document.getElementById('btnBack'),
        btnReload: document.getElementById('btnReload'),
        errBox: document.getElementById('errBox'),
        mainWrap: document.getElementById('mainWrap'),
        officer: document.getElementById('officer'),
        fiscal: document.getElementById('fiscal'),
        group: document.getElementById('group'),
        startDate: document.getElementById('startDate'),
        endDate: document.getElementById('endDate'),
        startTime: document.getElementById('startTime'),
        endTime: document.getElementById('endTime'),
        btnSearch: document.getElementById('btnSearch'),
        btnReset: document.getElementById('btnReset'),
        activeFilterBadge: document.getElementById('activeFilterBadge'),
        statWrap: document.getElementById('statWrap'),
        statTotal: document.getElementById('statTotal'),
        statOfficer: document.getElementById('statOfficer'),
        statFiscal: document.getElementById('statFiscal'),
        statDateRange: document.getElementById('statDateRange'),
        btnPrint: document.getElementById('btnPrint'),
        docsWrap: document.getElementById('docsWrap')
      };

      function showError(message) {
        var msg = C.safeTrim(message || '');
        if (!msg) {
          els.errBox.classList.add('hidden');
          els.errBox.textContent = '';
          return;
        }
        els.errBox.textContent = msg;
        els.errBox.classList.remove('hidden');
      }

      function fillOptions() {
        var members = Array.isArray(state.members) ? state.members : [];
        var info = (state.options && state.options.data) ? state.options.data : { fiscalYears: [], groups: [] };
        var fiscalYears = Array.isArray(info.fiscalYears) ? info.fiscalYears : [];
        var groups = Array.isArray(info.groups) ? info.groups : [];

        var officerHtml = '<option value="">เลือกเจ้าหน้าที่...</option>';
        for (var i = 0; i < members.length; i++) {
          var m = members[i] || {};
          var name = C.safeTrim(m.name || '');
          if (!name) continue;
          var pos = C.safeTrim(m.position || '');
          var label = pos ? (name + ' (' + pos + ')') : name;
          officerHtml += '<option value="' + C.escapeHtml(name) + '">' + C.escapeHtml(label) + '</option>';
        }
        els.officer.innerHTML = officerHtml;

        var fiscalHtml = '<option value="">ทั้งหมด</option>';
        for (var f = 0; f < fiscalYears.length; f++) {
          fiscalHtml += '<option value="' + C.escapeHtml(fiscalYears[f]) + '">' + C.escapeHtml(fiscalYears[f]) + '</option>';
        }
        els.fiscal.innerHTML = fiscalHtml;

        var groupHtml = '<option value="">ทั้งหมด</option>';
        for (var g = 0; g < groups.length; g++) {
          groupHtml += '<option value="' + C.escapeHtml(groups[g]) + '">' + C.escapeHtml(groups[g]) + '</option>';
        }
        els.group.innerHTML = groupHtml;

        var preferredName = C.safeTrim((state.user && state.user.displayName) || '');
        if (preferredName) {
          for (var p = 0; p < els.officer.options.length; p++) {
            if (els.officer.options[p].value === preferredName) {
              els.officer.selectedIndex = p;
              break;
            }
          }
        }
      }

      function selectedFiltersCount() {
        var count = 0;
        if (C.safeTrim(els.fiscal.value)) count++;
        if (C.safeTrim(els.group.value)) count++;
        if (C.safeTrim(els.startDate.value) || C.safeTrim(els.endDate.value)) count++;
        if (C.safeTrim(els.startTime.value) || C.safeTrim(els.endTime.value)) count++;
        return count;
      }

      function renderActiveFilterBadge() {
        var count = selectedFiltersCount();
        if (count <= 0) {
          els.activeFilterBadge.classList.add('hidden');
          return;
        }
        els.activeFilterBadge.classList.remove('hidden');
        els.activeFilterBadge.innerHTML = '<i class="bi bi-funnel"></i> ' + count + ' ตัวกรอง';
      }

      function dateRangeText() {
        var startDate = C.safeTrim(els.startDate.value || '');
        var endDate = C.safeTrim(els.endDate.value || '');
        var startTime = C.safeTrim(els.startTime.value || '');
        var endTime = C.safeTrim(els.endTime.value || '');

        var text = '';
        if (startDate && endDate) text = 'ช่วงวันที่: ' + startDate + ' - ' + endDate;
        else if (startDate) text = 'ตั้งแต่วันที่: ' + startDate;
        else if (endDate) text = 'ถึงวันที่: ' + endDate;

        var t = '';
        if (startTime && endTime) t = 'เวลา: ' + startTime + ' - ' + endTime;
        else if (startTime) t = 'ตั้งแต่เวลา: ' + startTime;
        else if (endTime) t = 'ถึงเวลา: ' + endTime;

        if (text && t) return text + ' | ' + t;
        return text || t;
      }

      function goDoc(id) {
        var docId = C.safeTrim(id || '');
        if (!docId) return;
        C.redirect('doc-view.html', { id: docId });
      }

      function renderDocs() {
        var docs = Array.isArray(state.docs) ? state.docs : [];
        if (!docs.length) {
          els.docsWrap.className = 'empty';
          els.docsWrap.textContent = 'ไม่พบเอกสารที่ตรงเงื่อนไข';
          els.btnPrint.classList.add('hidden');
          return;
        }

        var html = '';
        for (var i = 0; i < docs.length; i++) {
          var d = docs[i] || {};
          var title = C.safeTrim(d.amDocNo || '') || C.safeTrim(d.docId || '-') || '-';
          var sdh = C.safeTrim(d.docNoSdh || '');
          var subject = C.safeTrim(d.subject || '-') || '-';
          var sender = C.safeTrim(d.sender || '-') || '-';
          var group = C.safeTrim(d.group || '-') || '-';
          var fiscal = C.safeTrim(d.fiscalYear || '-') || '-';
          var verifyDate = C.safeTrim(d.verifyDate || '-') || '-';

          html += '<div class="doc-item" data-doc-id="' + C.escapeHtml(d.docId || '') + '">';
          html += '<div class="doc-top">';
          html += '<div>';
          html += '<div class="doc-title">' + C.escapeHtml(title) + '</div>';
          if (sdh && sdh !== title) html += '<div class="doc-sub">สธ ' + C.escapeHtml(sdh) + '</div>';
          html += '</div>';
          html += '<div class="chip"><i class="bi bi-calendar-check"></i> ' + C.escapeHtml(verifyDate) + '</div>';
          html += '</div>';
          html += '<p class="doc-subject">' + C.escapeHtml(subject) + '</p>';
          html += '<div class="doc-meta">';
          html += '<span><i class="bi bi-building me-1"></i>' + C.escapeHtml(group) + '</span>';
          html += '<span><i class="bi bi-person me-1"></i>' + C.escapeHtml(sender) + '</span>';
          html += '<span><i class="bi bi-calendar3 me-1"></i>ปีงบฯ ' + C.escapeHtml(fiscal) + '</span>';
          if (C.safeTrim(d.purpose || '')) html += '<span><i class="bi bi-tag me-1"></i>' + C.escapeHtml(d.purpose) + '</span>';
          html += '</div>';
          html += '</div>';
        }

        els.docsWrap.className = '';
        els.docsWrap.innerHTML = html;
        els.btnPrint.classList.remove('hidden');

        var items = els.docsWrap.querySelectorAll('.doc-item');
        for (var j = 0; j < items.length; j++) {
          items[j].addEventListener('click', function () {
            goDoc(this.getAttribute('data-doc-id') || '');
          });
        }
      }

      function buildSearchPayload() {
        var officerName = C.safeTrim(els.officer.value || '');
        var fiscal = C.safeTrim(els.fiscal.value || '');
        var group = C.safeTrim(els.group.value || '');
        var startDate = C.safeTrim(els.startDate.value || '');
        var endDate = C.safeTrim(els.endDate.value || '');
        var startTime = C.safeTrim(els.startTime.value || '');
        var endTime = C.safeTrim(els.endTime.value || '');

        if (!officerName) {
          throw new Error('กรุณาเลือกเจ้าหน้าที่');
        }

        if (startDate && endDate && startDate > endDate) {
          var tmpDate = startDate;
          startDate = endDate;
          endDate = tmpDate;
          els.startDate.value = startDate;
          els.endDate.value = endDate;
        }

        return {
          officerName: officerName,
          selectedFiscalYears: fiscal ? [fiscal] : [],
          startDate: startDate,
          endDate: endDate,
          startTime: startTime,
          endTime: endTime,
          group: group
        };
      }

      async function searchReport() {
        showError('');
        renderActiveFilterBadge();

        var payload;
        try {
          payload = buildSearchPayload();
        } catch (err) {
          Swal.fire('ข้อมูลไม่ครบ', err.message || 'กรุณาตรวจสอบตัวกรอง', 'warning');
          return;
        }

        els.btnSearch.disabled = true;
        els.docsWrap.className = 'empty';
        els.docsWrap.textContent = 'กำลังโหลดข้อมูล...';

        try {
          var res = await state.api.inspectionReport(payload);
          if (!res || res.success === false) {
            throw new Error((res && res.error) ? res.error : 'ไม่สามารถดึงรายงานได้');
          }

          state.docs = Array.isArray(res.documents) ? res.documents : [];
          state.reportMeta.officerName = C.safeTrim(res.officerName || payload.officerName);
          state.reportMeta.fiscalYear = C.safeTrim(res.fiscalYear || (payload.selectedFiscalYears.length ? payload.selectedFiscalYears.join(', ') : 'ทั้งหมด'));

          els.statWrap.classList.remove('hidden');
          els.statTotal.textContent = String(Number(res.totalCount || state.docs.length || 0));
          els.statOfficer.textContent = state.reportMeta.officerName || '-';
          els.statFiscal.textContent = 'ปีงบประมาณ: ' + (state.reportMeta.fiscalYear || 'ทั้งหมด');
          els.statDateRange.textContent = dateRangeText();

          renderDocs();
        } catch (err2) {
          els.docsWrap.className = 'empty';
          els.docsWrap.textContent = 'ไม่สามารถโหลดรายงานได้';
          showError((err2 && err2.message) ? err2.message : 'ไม่สามารถโหลดรายงานได้');
        } finally {
          els.btnSearch.disabled = false;
        }
      }

      function resetFilters() {
        if (els.fiscal.options.length > 0) els.fiscal.value = '';
        if (els.group.options.length > 0) els.group.value = '';
        els.startDate.value = '';
        els.endDate.value = '';
        els.startTime.value = '';
        els.endTime.value = '';
        renderActiveFilterBadge();
      }

      function printReport() {
        if (!state.docs.length) {
          Swal.fire('ไม่มีข้อมูล', 'ไม่พบเอกสารสำหรับพิมพ์', 'warning');
          return;
        }

        var w = window.open('', '', 'width=1220,height=820');
        if (!w) {
          Swal.fire('ไม่สามารถเปิดหน้าต่างพิมพ์', 'กรุณาอนุญาต Pop-up', 'info');
          return;
        }

        var esc = C.escapeHtml;
        var officer = state.reportMeta.officerName || '-';
        var fiscal = state.reportMeta.fiscalYear || 'ทั้งหมด';
        var dr = dateRangeText();

        var h = '';
        h += '<!doctype html><html><head><meta charset="utf-8"><title>รายงานผลงาน</title>';
        h += '<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Thai:wght@400;500;700&display=swap" rel="stylesheet">';
        h += '<style>@page{size:A4 landscape;margin:8mm}body{font-family:"IBM Plex Sans Thai",sans-serif;margin:0;padding:8px;color:#0f172a}h2{margin:0 0 2px;text-align:center;font-size:21px;font-weight:800}.sub{margin:0 0 8px;text-align:center;font-size:12px;color:#1f2937}.meta{margin:0 0 8px;text-align:center;font-size:11px;color:#334155}table{width:100%;border-collapse:collapse;table-layout:fixed}th,td{border:1px solid #334155;padding:4px 5px;font-size:10.2px;line-height:1.28;vertical-align:top}th{background:#e2e8f0;text-align:center;font-weight:800}.text-center{text-align:center}.text-right{text-align:right}.subject,.group,.sender{white-space:normal;overflow-wrap:anywhere;word-break:break-word}@media print{button{display:none!important}}</style>';
        h += '</head><body>';
        h += '<h2>รายงานผลงานการตรวจสอบเอกสาร</h2>';
        h += '<p class="sub">เจ้าหน้าที่: <strong>' + esc(officer) + '</strong> | ปีงบประมาณ: <strong>' + esc(fiscal) + '</strong>' + (dr ? (' | ' + esc(dr)) : '') + ' | จำนวนรวม: <strong>' + state.docs.length + ' ฉบับ</strong></p>';
        h += '<p class="meta">พิมพ์เมื่อ: ' + esc(new Date().toLocaleString('th-TH')) + '</p>';
        h += '<table><thead><tr><th style="width:4%">ลำดับ</th><th style="width:6%">ปีงบฯ</th><th style="width:11%">เลขที่หนังสือส่งกองคลัง</th><th style="width:9%">เลขที่ สธ.</th><th style="width:25%">ชื่อเรื่อง</th><th style="width:10%">วันที่ตรวจสอบ</th><th style="width:11%">กลุ่ม/ศูนย์</th><th style="width:14%">ผู้ส่ง</th><th style="width:5%">จำนวน</th><th style="width:5%">ส่วนต่าง</th></tr></thead><tbody>';

        for (var i = 0; i < state.docs.length; i++) {
          var d = state.docs[i] || {};
          var subject = C.safeText(d.subject || '-');
          if (subject.length > 240) subject = subject.substring(0, 240).replace(/\s+$/, '') + '...';
          h += '<tr>';
          h += '<td class="text-center">' + (i + 1) + '</td>';
          h += '<td class="text-center">' + esc(d.fiscalYear || '') + '</td>';
          h += '<td class="text-center">' + esc(d.amDocNo || '') + '</td>';
          h += '<td class="text-center">' + esc(d.docNoSdh || '') + '</td>';
          h += '<td class="subject">' + esc(subject) + '</td>';
          h += '<td class="text-center">' + esc(d.verifyDate || '') + '</td>';
          h += '<td class="group">' + esc(d.group || '') + '</td>';
          h += '<td class="sender">' + esc(d.sender || '') + '</td>';
          h += '<td class="text-right">' + esc(d.amount || '') + '</td>';
          h += '<td class="text-right">' + esc(d.difference || '') + '</td>';
          h += '</tr>';
        }

        h += '</tbody></table>';
        h += '<script>window.onload=function(){window.print();window.close();}<' + '/script>';
        h += '</body></html>';

        w.document.write(h);
        w.document.close();
      }

      async function initData() {
        var data = await Promise.all([
          state.api.me(),
          state.api.optionsInfo(),
          state.api.optionsMembers()
        ]);

        var meRes = data[0] || {};
        var infoRes = data[1] || {};
        var membersRes = data[2] || {};

        if (!meRes || meRes.success === false || !meRes.user) {
          C.redirect('index.html', {}, true);
          return false;
        }

        state.user = meRes.user;
        state.options = infoRes || { data: { fiscalYears: [], groups: [] } };
        state.members = (membersRes && Array.isArray(membersRes.data)) ? membersRes.data : [];

        return true;
      }

      async function init() {
        try {
          state.settings = C.ensureSettingsOrThrow();
          state.api = C.createApiClient(state.settings);
        } catch (_e) {
          showError('กรุณาตั้งค่า scriptUrl และ deviceKey ที่หน้า index ก่อน');
          return;
        }

        els.btnBack.onclick = function () { C.redirect('index.html'); };
        els.btnReload.onclick = function () { searchReport(); };
        els.btnSearch.onclick = function () { searchReport(); };
        els.btnReset.onclick = function () { resetFilters(); };
        els.btnPrint.onclick = function () { printReport(); };

        try {
          var ok = await initData();
          if (!ok) return;
          fillOptions();
          renderActiveFilterBadge();
          els.mainWrap.classList.remove('hidden');

          if (C.safeTrim(els.officer.value || '')) {
            searchReport();
          }
        } catch (err) {
          showError((err && err.message) ? err.message : 'โหลดข้อมูลหน้าเครื่องมือตรวจสอบไม่สำเร็จ');
        }
      }

      init();
    })();
  </script>
</body>
</html>
