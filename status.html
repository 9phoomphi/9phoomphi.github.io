<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>จัดการสถานะเอกสาร</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Thai:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    :root {
      --bg: #f3f6fb;
      --card: rgba(255,255,255,0.92);
      --text: #0f172a;
      --muted: #475569;
      --border: #dbe4f0;
      --primary: #2563eb;
      --primary2: #1d4ed8;
      --success: #16a34a;
      --danger: #dc2626;
      --shadow: 0 18px 46px rgba(15,23,42,0.14);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "IBM Plex Sans Thai", sans-serif;
      color: var(--text);
      background: radial-gradient(1200px 540px at 8% -14%, rgba(59,130,246,0.22), rgba(59,130,246,0)), var(--bg);
    }

    .shell { max-width: 980px; margin: 0 auto; padding: 14px; }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 18px;
      box-shadow: var(--shadow);
      padding: 14px;
      margin-bottom: 12px;
      backdrop-filter: saturate(160%) blur(8px);
    }

    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .title { margin: 0; font-size: 1.1rem; font-weight: 800; }
    .muted { color: var(--muted); }

    .btn {
      border: none;
      border-radius: 999px;
      height: 38px;
      padding: 0 14px;
      color: #fff;
      font: inherit;
      font-weight: 700;
      cursor: pointer;
      background: linear-gradient(180deg, var(--primary), var(--primary2));
    }

    .btn.secondary { background: #334155; }
    .btn.outline { background: #fff; color: var(--primary2); border: 1px solid #93c5fd; }

    .error {
      border: 1px solid rgba(220,38,38,.35);
      background: rgba(220,38,38,.08);
      color: #991b1b;
      border-radius: 10px;
      padding: 10px;
      font-size: 0.9rem;
    }

    .hidden { display: none !important; }

    .step {
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 12px;
      margin-bottom: 10px;
      background: #f8fbff;
    }

    .step-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 8px;
    }

    .step-title {
      font-size: 0.95rem;
      font-weight: 800;
      color: #1e3a8a;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .step-body {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
    }

    .field { display: grid; gap: 4px; }

    .label {
      font-size: 0.78rem;
      color: var(--muted);
      font-weight: 700;
    }

    input, select {
      width: 100%;
      border: 1px solid var(--border);
      border-radius: 10px;
      min-height: 40px;
      padding: 8px 10px;
      font: inherit;
      color: var(--text);
      background: #fff;
    }

    .step.disabled {
      opacity: 0.6;
      background: #f1f5f9;
    }

    .switch {
      position: relative;
      display: inline-block;
      width: 56px;
      height: 30px;
    }

    .switch input { opacity: 0; width: 0; height: 0; }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #cbd5e1;
      transition: .2s;
      border-radius: 999px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 24px;
      width: 24px;
      left: 3px;
      top: 3px;
      background-color: #fff;
      transition: .2s;
      border-radius: 50%;
      box-shadow: 0 2px 8px rgba(0,0,0,.24);
    }

    .switch input:checked + .slider {
      background-color: var(--success);
    }

    .switch input:checked + .slider:before {
      transform: translateX(26px);
    }

    .member-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .member-avatar {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      border: 1px solid #93c5fd;
      object-fit: cover;
      background: #e2e8f0;
      flex-shrink: 0;
    }

    .doc-chip {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 6px 12px;
      background: #eef4ff;
      color: #334155;
      font-size: .82rem;
      font-weight: 700;
    }

    @media (max-width: 900px) {
      .step-body { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="shell">
    <div class="card topbar">
      <div>
        <h1 class="title">จัดการสถานะเอกสาร</h1>
        <div id="docHead" class="muted" style="font-size:0.84rem">กำลังโหลด...</div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;">
        <button id="btnBack" class="btn secondary" type="button"><i class="bi bi-arrow-left"></i> กลับ</button>
        <button id="btnReload" class="btn outline" type="button"><i class="bi bi-arrow-clockwise"></i> โหลดใหม่</button>
      </div>
    </div>

    <div id="errBox" class="error hidden"></div>

    <div id="mainWrap" class="hidden">
      <div class="card">
        <div class="doc-chip"><i class="bi bi-file-earmark-text"></i> <span id="docChip">-</span></div>
      </div>

      <div id="stepsWrap" class="card"></div>

      <div class="card" style="text-align:center;">
        <button id="btnSubmit" class="btn" type="button"><i class="bi bi-save-fill"></i> บันทึกสถานะ</button>
      </div>
    </div>
  </div>

  <script src="./config.js"></script>
  <script src="./api-client.js"></script>
  <script src="./app-common.js"></script>
  <script>
    (function () {
      'use strict';

      var C = window.DocFrontendCommon;
      var query = C.parseQuery();
      var docId = C.safeTrim(query.id || '');

      var STEP_META = [
        { key: 'return', label: 'ส่งกลับแก้ไข', icon: 'bi-arrow-return-right' },
        { key: 'receiveBack', label: 'รับคืนเอกสารที่ส่งกลับ', icon: 'bi-box-arrow-in-down' },
        { key: 'verify', label: 'ตรวจสอบ', icon: 'bi-search' },
        { key: 'boss', label: 'หัวหน้าผ่านงาน', icon: 'bi-person-check' },
        { key: 'sign', label: 'เสนอลงนาม', icon: 'bi-pen' }
      ];

      var state = {
        settings: null,
        api: null,
        user: null,
        doc: null,
        statusData: {},
        members: [],
        memberImageMap: {}
      };

      var els = {
        docHead: document.getElementById('docHead'),
        btnBack: document.getElementById('btnBack'),
        btnReload: document.getElementById('btnReload'),
        errBox: document.getElementById('errBox'),
        mainWrap: document.getElementById('mainWrap'),
        docChip: document.getElementById('docChip'),
        stepsWrap: document.getElementById('stepsWrap'),
        btnSubmit: document.getElementById('btnSubmit')
      };

      function showError(message) {
        var msg = C.safeTrim(message || '');
        if (!msg) {
          els.errBox.classList.add('hidden');
          els.errBox.textContent = '';
          return;
        }
        els.errBox.textContent = msg;
        els.errBox.classList.remove('hidden');
      }

      function normalizeMemberImageMap(members) {
        var map = {};
        var list = Array.isArray(members) ? members : [];
        for (var i = 0; i < list.length; i++) {
          var m = list[i] || {};
          var name = C.safeTrim(m.name || '');
          var image = C.safeTrim(m.image || '');
          if (!name || !image) continue;
          map[name] = image;
          map[name.toLowerCase()] = image;
        }
        return map;
      }

      function memberOptionsHtml(selectedValue) {
        var selected = C.safeTrim(selectedValue || '');
        var html = '<option value="">เลือกชื่อ...</option>';
        for (var i = 0; i < state.members.length; i++) {
          var m = state.members[i] || {};
          var name = C.safeTrim(m.name || '');
          if (!name) continue;
          var pos = C.safeTrim(m.position || '');
          var label = pos ? (name + ' (' + pos + ')') : name;
          html += '<option value="' + C.escapeHtml(name) + '"' + (name === selected ? ' selected' : '') + '>' + C.escapeHtml(label) + '</option>';
        }
        return html;
      }

      function avatarHtml(name) {
        var key = C.safeTrim(name || '');
        var img = state.memberImageMap[key] || state.memberImageMap[key.toLowerCase()] || '';
        if (img) {
          return '<img class="member-avatar" src="' + C.escapeHtml(img) + '" alt="u">';
        }
        return '<img class="member-avatar" src="https://dummyimage.com/30x30/e2e8f0/64748b.png&text=' + encodeURIComponent((key.charAt(0) || '?').toUpperCase()) + '" alt="u">';
      }

      function stepValueKey(baseKey, suffix) {
        return baseKey + suffix;
      }

      function fieldId(baseKey, name) {
        return 'step_' + baseKey + '_' + name;
      }

      function toggleStep(baseKey) {
        var checkEl = document.getElementById(fieldId(baseKey, 'check'));
        var dateEl = document.getElementById(fieldId(baseKey, 'date'));
        var userEl = document.getElementById(fieldId(baseKey, 'user'));
        var blockEl = document.getElementById(fieldId(baseKey, 'block'));

        if (!checkEl || !dateEl || !userEl || !blockEl) return;

        var checked = !!checkEl.checked;
        dateEl.disabled = !checked;
        userEl.disabled = !checked;
        blockEl.classList.toggle('disabled', !checked);

        if (checked && !C.safeTrim(dateEl.value || '')) {
          var now = new Date();
          var mm = String(now.getMonth() + 1).padStart(2, '0');
          var dd = String(now.getDate()).padStart(2, '0');
          dateEl.value = now.getFullYear() + '-' + mm + '-' + dd;
        }
      }

      function updateMemberAvatar(baseKey) {
        var userEl = document.getElementById(fieldId(baseKey, 'user'));
        var avatarEl = document.getElementById(fieldId(baseKey, 'avatar'));
        if (!userEl || !avatarEl) return;
        avatarEl.innerHTML = avatarHtml(userEl.value || '');
      }

      function renderSteps() {
        var s = state.statusData || {};
        var html = '';

        for (var i = 0; i < STEP_META.length; i++) {
          var meta = STEP_META[i];
          var checkKey = stepValueKey(meta.key, 'Check');
          var dateKey = stepValueKey(meta.key, 'DateInput');
          var userKey = stepValueKey(meta.key, 'User');

          var checked = !!s[checkKey];
          var dateVal = C.safeTrim(s[dateKey] || '');
          var userVal = C.safeTrim(s[userKey] || '');

          html += '<div id="' + fieldId(meta.key, 'block') + '" class="step ' + (checked ? '' : 'disabled') + '">';
          html += '<div class="step-head">';
          html += '<div class="step-title"><i class="bi ' + C.escapeHtml(meta.icon) + '"></i> ' + C.escapeHtml(meta.label) + '</div>';
          html += '<label class="switch"><input id="' + fieldId(meta.key, 'check') + '" type="checkbox"' + (checked ? ' checked' : '') + '><span class="slider"></span></label>';
          html += '</div>';

          html += '<div class="step-body">';
          html += '<div class="field">';
          html += '<div class="label">วันที่</div>';
          html += '<input id="' + fieldId(meta.key, 'date') + '" type="date" value="' + C.escapeHtml(dateVal) + '"' + (checked ? '' : ' disabled') + '>';
          html += '</div>';

          html += '<div class="field">';
          html += '<div class="label">ผู้ดำเนินการ</div>';
          html += '<div class="member-row">';
          html += '<div id="' + fieldId(meta.key, 'avatar') + '">' + avatarHtml(userVal) + '</div>';
          html += '<select id="' + fieldId(meta.key, 'user') + '"' + (checked ? '' : ' disabled') + '>' + memberOptionsHtml(userVal) + '</select>';
          html += '</div>';
          html += '</div>';
          html += '</div>';
          html += '</div>';
        }

        els.stepsWrap.innerHTML = html;

        for (var j = 0; j < STEP_META.length; j++) {
          (function bind(meta) {
            var checkEl = document.getElementById(fieldId(meta.key, 'check'));
            var userEl = document.getElementById(fieldId(meta.key, 'user'));
            if (checkEl) {
              checkEl.addEventListener('change', function () {
                toggleStep(meta.key);
              });
            }
            if (userEl) {
              userEl.addEventListener('change', function () {
                updateMemberAvatar(meta.key);
              });
            }
          })(STEP_META[j]);
        }
      }

      function collectStatusData() {
        var payload = {};

        for (var i = 0; i < STEP_META.length; i++) {
          var meta = STEP_META[i];
          var checked = !!(document.getElementById(fieldId(meta.key, 'check')) || {}).checked;
          var dateVal = C.safeTrim((document.getElementById(fieldId(meta.key, 'date')) || {}).value || '');
          var userVal = C.safeTrim((document.getElementById(fieldId(meta.key, 'user')) || {}).value || '');

          payload[stepValueKey(meta.key, 'Check')] = checked;
          payload[stepValueKey(meta.key, 'Date')] = dateVal;
          payload[stepValueKey(meta.key, 'User')] = userVal;
        }

        return payload;
      }

      async function submitStatus() {
        if (!state.user || state.user.isReadOnly || state.user.canEdit === false) {
          Swal.fire('สิทธิ์ไม่เพียงพอ', 'บัญชีผู้มีสิทธิ์อ่าน ไม่สามารถแก้ไขสถานะได้', 'warning');
          return;
        }

        var payload = collectStatusData();

        els.btnSubmit.disabled = true;
        try {
          var res = await state.api.docUpdateStatus(state.doc.docId || docId, payload);
          if (!res || res.success === false) throw new Error((res && res.error) ? res.error : 'บันทึกไม่สำเร็จ');
          await Swal.fire('บันทึกสำเร็จ', 'อัปเดตสถานะเรียบร้อย', 'success');
          C.redirect('doc-view.html', { id: state.doc.docId || docId }, true);
        } catch (err) {
          Swal.fire('เกิดข้อผิดพลาด', (err && err.message) ? err.message : 'บันทึกไม่สำเร็จ', 'error');
        } finally {
          els.btnSubmit.disabled = false;
        }
      }

      async function loadData() {
        showError('');
        els.mainWrap.classList.add('hidden');

        try {
          var responses = await Promise.all([
            state.api.me(),
            state.api.docDetail(docId),
            state.api.optionsMembers()
          ]);

          var meRes = responses[0] || {};
          var detailRes = responses[1] || {};
          var membersRes = responses[2] || {};

          if (!meRes || meRes.success === false || !meRes.user) {
            C.redirect('index.html', {}, true);
            return;
          }

          if (!detailRes || detailRes.success === false || !detailRes.doc) {
            throw new Error((detailRes && detailRes.error) ? detailRes.error : 'ไม่พบข้อมูลเอกสาร');
          }

          state.user = meRes.user;
          state.doc = detailRes.doc;
          state.statusData = detailRes.statusData || {};
          state.members = (membersRes && Array.isArray(membersRes.data)) ? membersRes.data : [];
          state.memberImageMap = normalizeMemberImageMap(state.members);

          els.docHead.textContent = (state.doc.docId || '-') + ' | เลขรับ ' + (state.doc.receiveNo || '-');
          els.docChip.textContent = (state.doc.docStatus || '-') + (state.user.isReadOnly ? ' | สิทธิ์อ่านเท่านั้น' : '');

          renderSteps();

          if (state.user.isReadOnly || state.user.canEdit === false) {
            els.btnSubmit.disabled = true;
            els.btnSubmit.textContent = 'บัญชีนี้ไม่สามารถแก้ไขสถานะ';
          }

          els.mainWrap.classList.remove('hidden');
        } catch (err) {
          showError((err && err.message) ? err.message : 'โหลดข้อมูลสถานะไม่สำเร็จ');
        }
      }

      function init() {
        if (!docId) {
          showError('ไม่พบพารามิเตอร์ id');
          return;
        }

        try {
          state.settings = C.ensureSettingsOrThrow();
          state.api = C.createApiClient(state.settings);
        } catch (_e) {
          showError('กรุณาตั้งค่า scriptUrl และ deviceKey ที่หน้า index ก่อน');
          return;
        }

        els.btnBack.onclick = function () {
          C.redirect('doc-view.html', { id: docId });
        };

        els.btnReload.onclick = function () {
          loadData();
        };

        els.btnSubmit.onclick = function () {
          submitStatus();
        };

        loadData();
      }

      init();
    })();
  </script>
</body>
</html>
